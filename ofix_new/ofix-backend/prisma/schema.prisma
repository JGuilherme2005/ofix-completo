generator client {
  provider        = "prisma-client-js"
  // Deixe o Prisma escolher o engine "native" do ambiente de build (Render usa OpenSSL 3).
  binaryTargets   = ["native"]
  previewFeatures = ["relationJoins"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
  // relationMode removido: agora usa o default "foreignKeys" do PostgreSQL.
  // FKs reais s√£o enforced no banco (M2-DB-05).
  // Configura√ß√µes para resolver prepared statements em ambientes cloud
  // Use ?pgbouncer=true na DATABASE_URL
}

model User {
  id           String        @id @default(uuid())
  nome         String
  email        String        @unique
  password     String
  role         UserRole      @default(ADMIN)
  oficinaId    String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  oficina      Oficina?      @relation(fields: [oficinaId], references: [id])
  servicos     Servico[]
  chatSessions ChatSession[]

  @@index([oficinaId])
}

model Oficina {
  id                    String               @id @default(uuid())
  nome                  String
  // Slug publico para URLs (ex: /chat/oficina-do-ze). Opcional para manter compatibilidade.
  slug                  String?              @unique
  // Flag para desativar a oficina sem deletar dados (necessario para chat-public).
  isActive              Boolean              @default(true)
  cnpj                  String?              @unique
  telefone              String?
  endereco              String?
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  users                 User[]
  clientes              Cliente[]
  veiculos              Veiculo[]
  servicos              Servico[]
  pecas                 Peca[]
  fornecedores          Fornecedor[]
  procedimentosPadrao   ProcedimentoPadrao[]
  mensagensPadrao       MensagemPadrao[]
  transacoesFinanceiras Financeiro[]
  chatSessions          ChatSession[]
  agendamentos          Agendamento[]
}

model Cliente {
  id           String        @id @default(uuid())
  nomeCompleto String
  cpfCnpj      String?
  telefone     String?
  email        String?
  endereco     String?
  oficinaId    String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  oficina      Oficina       @relation(fields: [oficinaId], references: [id])
  veiculos     Veiculo[]
  servicos     Servico[]
  agendamentos Agendamento[]

  @@unique([oficinaId, cpfCnpj])
  @@unique([oficinaId, email])
  @@index([oficinaId, nomeCompleto])
  @@index([oficinaId, createdAt])
}

model Veiculo {
  id            String        @id @default(uuid())
  placa         String
  marca         String
  modelo        String
  anoFabricacao Int?
  anoModelo     Int?
  cor           String?
  chassi        String?
  kmAtual       Int?
  clienteId     String
  oficinaId     String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  cliente       Cliente       @relation(fields: [clienteId], references: [id])
  oficina       Oficina       @relation(fields: [oficinaId], references: [id])
  servicos      Servico[]
  agendamentos  Agendamento[]

  @@unique([oficinaId, placa])
  @@unique([oficinaId, chassi])
  @@index([oficinaId, clienteId])
}

model Servico {
  id                  String                      @id @default(uuid())
  numeroOs            String
  status              ServiceStatus               @default(AGUARDANDO)
  descricaoProblema   String?
  descricaoSolucao    String?
  dataEntrada         DateTime                    @default(now())
  dataPrevisaoEntrega DateTime?
  dataConclusao       DateTime?
  dataEntregaCliente  DateTime?
  valorTotalEstimado  Decimal?
  valorTotalServicos  Decimal?
  valorTotalPecas     Decimal?
  valorTotalFinal     Decimal?
  kmEntrada           Int?
  checklist           Json?
  observacoes         String?
  clienteId           String?
  veiculoId           String
  responsavelId       String?
  oficinaId           String
  createdAt           DateTime                    @default(now())
  updatedAt           DateTime                    @updatedAt
  cliente             Cliente?                    @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  veiculo             Veiculo                     @relation(fields: [veiculoId], references: [id])
  responsavel         User?                       @relation(fields: [responsavelId], references: [id])
  oficina             Oficina                     @relation(fields: [oficinaId], references: [id])
  itensPeca           ItemServicoPeca[]
  procedimentos       ProcedimentoPadraoServico[]
  mensagens           MensagemServico[]
  agendamentos        Agendamento[]
  financeiros         Financeiro[]

  @@unique([oficinaId, numeroOs])
  @@index([oficinaId, status, dataEntrada])
  @@index([oficinaId, clienteId])
  @@index([oficinaId, veiculoId])
}

model Peca {
  id               String            @id @default(uuid())
  codigoInterno    String?
  codigoFabricante String?
  nome             String
  descricao        String?
  fabricante       String?
  unidadeMedida    String            @default("UN")
  precoCusto       Decimal?
  precoVenda       Decimal
  estoqueAtual     Int               @default(0)
  estoqueMinimo    Int?              @default(0)
  localizacao      String?
  oficinaId        String
  fornecedorId     String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  oficina          Oficina           @relation(fields: [oficinaId], references: [id])
  fornecedor       Fornecedor?       @relation(fields: [fornecedorId], references: [id])
  servicos         ItemServicoPeca[]

  @@unique([oficinaId, codigoInterno])
  @@index([oficinaId, nome])
  @@index([oficinaId, fornecedorId])
}

model Fornecedor {
  id        String   @id @default(uuid())
  nome      String
  cnpjCpf   String?
  telefone  String?
  email     String?
  endereco  String?
  oficinaId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  oficina   Oficina  @relation(fields: [oficinaId], references: [id])
  pecas     Peca[]

  @@unique([oficinaId, cnpjCpf])
  @@unique([oficinaId, email])
  @@index([oficinaId, nome])
}

model ItemServicoPeca {
  id                   String   @id @default(uuid())
  servicoId            String
  pecaId               String
  quantidade           Int
  precoUnitarioCobrado Decimal
  valorTotal           Decimal
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  servico              Servico  @relation(fields: [servicoId], references: [id])
  peca                 Peca     @relation(fields: [pecaId], references: [id])

  @@unique([servicoId, pecaId])
}

model ProcedimentoPadrao {
  id                 String                      @id @default(uuid())
  codigo             String?
  nome               String
  descricao          String?
  tempoEstimadoHoras Decimal?
  checklistJson      Json?
  oficinaId          String
  createdAt          DateTime                    @default(now())
  updatedAt          DateTime                    @updatedAt
  categoria          String?                     @default("manutencao_preventiva")
  oficina            Oficina                     @relation(fields: [oficinaId], references: [id])
  servicos           ProcedimentoPadraoServico[]

  @@unique([oficinaId, codigo])
  @@index([oficinaId, nome])
}

model ProcedimentoPadraoServico {
  id                   String             @id @default(uuid())
  servicoId            String
  procedimentoPadraoId String
  observacoes          String?
  concluido            Boolean            @default(false)
  dataConclusao        DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  servico              Servico            @relation(fields: [servicoId], references: [id])
  procedimentoPadrao   ProcedimentoPadrao @relation(fields: [procedimentoPadraoId], references: [id])

  @@unique([servicoId, procedimentoPadraoId])
}

model MensagemPadrao {
  id        String   @id @default(uuid())
  codigo    String?
  nome      String
  template  String
  oficinaId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  categoria String?
  oficina   Oficina  @relation(fields: [oficinaId], references: [id])

  @@unique([oficinaId, codigo])
}

model MensagemServico {
  id         String   @id @default(uuid())
  servicoId  String
  conteudo   String
  tipoEnvio  String
  dataEnvio  DateTime @default(now())
  enviadoPor String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  servico    Servico  @relation(fields: [servicoId], references: [id])
}

model Financeiro {
  id        String   @id @default(uuid())
  descricao String
  valor     Decimal
  tipo      String
  categoria String?
  data      DateTime
  servicoId String?
  oficinaId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  oficina   Oficina  @relation(fields: [oficinaId], references: [id])
  servico   Servico? @relation(fields: [servicoId], references: [id], onDelete: SetNull)

  @@index([oficinaId, data])
  @@index([oficinaId, tipo])
  @@index([servicoId])
}

enum UserRole {
  ADMIN
  USER
  GESTOR_OFICINA
}

enum ServiceStatus {
  AGUARDANDO
  EM_ANDAMENTO
  AGUARDANDO_PECAS
  AGUARDANDO_APROVACAO
  FINALIZADO
  CANCELADO
}

// =============================================================================
// ü§ñ MODELOS MATIAS (ASSISTENTE IA) ‚Äî UUID + Multi-tenant (Milestone 2)
// =============================================================================

/// Sess√£o de chat entre um usu√°rio (ou an√¥nimo) e o assistente Matias.
/// Substitui o legado ConversaMatias (Int, sem oficinaId).
model ChatSession {
  id        String   @id @default(uuid())
  titulo    String?
  status    String   @default("OPEN") // OPEN, CLOSED, ARCHIVED
  isPublic  Boolean  @default(false) // true = sess√£o do chat p√∫blico
  oficinaId String
  userId    String? // null = sess√£o an√¥nima (chat p√∫blico)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  oficina  Oficina       @relation(fields: [oficinaId], references: [id], onDelete: Cascade)
  user     User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  messages ChatMessage[]

  @@index([oficinaId, createdAt])
  @@index([oficinaId, userId])
  @@index([oficinaId, status])
  @@map("chat_sessions")
}

/// Mensagem individual dentro de uma ChatSession.
/// Substitui o legado MensagemMatias (Int, sem oficinaId).
model ChatMessage {
  id        String   @id @default(uuid())
  sessionId String
  role      String // "user", "assistant", "system"
  content   String
  metadata  Json? // tokens usados, model, tool calls, etc.
  createdAt DateTime @default(now())

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@map("chat_messages")
}

/// Agendamento de servi√ßo com isolamento por oficina.
/// Substitui o legado Agendamento (Int, sem oficinaId, sem FKs).
model Agendamento {
  id          String   @id @default(uuid())
  oficinaId   String
  clienteId   String
  veiculoId   String?
  servicoId   String?
  dataHora    DateTime
  tipo        String   @default("normal") // urgente, normal, programado, especial
  status      String   @default("PENDING") // PENDING, CONFIRMED, CANCELED, COMPLETED
  origem      String   @default("MANUAL") // MANUAL, AI_CHAT, WHATSAPP
  observacoes String?
  criadoPor   String? // userId ou "matias" se criado pela IA
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  oficina Oficina  @relation(fields: [oficinaId], references: [id], onDelete: Cascade)
  cliente Cliente  @relation(fields: [clienteId], references: [id], onDelete: Restrict)
  veiculo Veiculo? @relation(fields: [veiculoId], references: [id], onDelete: SetNull)
  servico Servico? @relation(fields: [servicoId], references: [id], onDelete: SetNull)

  @@index([oficinaId, dataHora])
  @@index([oficinaId, status])
  @@index([oficinaId, clienteId])
  @@map("agendamentos_v2")
}
